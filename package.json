const fs = require('fs');
const axios = require('axios');
const Parser = require('rss-parser');
require('dotenv').config();

const parser = new Parser();

// JSONãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
const feeds = JSON.parse(fs.readFileSync('./feeds.json', 'utf-8'));

// æŠ•ç¨¿æ¸ˆã¿IDã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆä½¿ã‚ãªã„å ´åˆã¯ç„¡è¦–ã—ã¦OKï¼‰
const postedIds = new Set();

async function checkFeeds() {
  for (const feed of feeds) {
    try {
      const feedData = await parser.parseURL(feed.url);

      for (const item of feedData.items) {
        const postId = item.link || item.guid;

        if (!postedIds.has(postId)) {
          postedIds.add(postId);

          const content =
            feed.raw === true
              ? item.contentSnippet || item.title
              : formatContent(item, feed.name);

          await axios.post(feed.webhook, {
            content,
          });

          console.log(`âœ… Posted: ${item.title}`);
        }
      }
    } catch (err) {
      console.error(`âŒ Error checking feed ${feed.name}:`, err.message);
    }
  }
}

function formatContent(item, name) {
  return `ğŸ“° **${name}**\n${item.title}\n${item.link}`;
}

checkFeeds();
