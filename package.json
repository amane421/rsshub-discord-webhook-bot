const fs = require('fs');
const axios = require('axios');
const Parser = require('rss-parser');
require('dotenv').config();

const parser = new Parser();

// JSONファイルの読み込み
const feeds = JSON.parse(fs.readFileSync('./feeds.json', 'utf-8'));

// 投稿済みIDキャッシュファイル（使わない場合は無視してOK）
const postedIds = new Set();

async function checkFeeds() {
  for (const feed of feeds) {
    try {
      const feedData = await parser.parseURL(feed.url);

      for (const item of feedData.items) {
        const postId = item.link || item.guid;

        if (!postedIds.has(postId)) {
          postedIds.add(postId);

          const content =
            feed.raw === true
              ? item.contentSnippet || item.title
              : formatContent(item, feed.name);

          await axios.post(feed.webhook, {
            content,
          });

          console.log(`✅ Posted: ${item.title}`);
        }
      }
    } catch (err) {
      console.error(`❌ Error checking feed ${feed.name}:`, err.message);
    }
  }
}

function formatContent(item, name) {
  return `📰 **${name}**\n${item.title}\n${item.link}`;
}

checkFeeds();
